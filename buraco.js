var J=Object.create,A=Object.defineProperty,B=Object.getPrototypeOf,U=Object.prototype.hasOwnProperty,F=Object.getOwnPropertyNames,Q=Object.getOwnPropertyDescriptor;var z=r=>A(r,"__esModule",{value:!0});var Y=(r,e,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of F(e))!U.call(r,s)&&s!=="default"&&A(r,s,{get:()=>e[s],enumerable:!(t=Q(e,s))||t.enumerable});return r},g=r=>r&&r.__esModule?r:Y(z(A(r!=null?J(B(r)):{},"default",{value:r,enumerable:!0})),r);var E=g(require("path"));var O=g(require("fs"));var l=r=>`[${r}m`,T={bold:l("1"),black:l("30"),red:l("31"),green:l("32"),yellow:l("33"),blue:l("34"),magenta:l("35"),cyan:l("36"),white:l("37"),gray:l("90"),bgBlack:l("40"),bgRed:l("41"),bgGreen:l("42"),bgYellow:l("43"),bgBlue:l("44"),bgMagenta:l("45"),bgCyan:l("46"),bgWhite:l("47"),bgGray:l("100"),reset:l("0")};function X(r){return r.endsWith(T.reset)?r:`${r}${T.reset}`}var n=Object.keys(T).reduce((r,e)=>({...r,[e]:t=>X(`${T[e]}${t}`)}),{});var v="\u2665\u2666\u2663\u2660".split(""),j;(function(r){r[r.Heart=0]="Heart",r[r.Diamonds=1]="Diamonds",r[r.Clubs=2]="Clubs",r[r.Spades=3]="Spades"})(j||(j={}));var P=["2","3","4","5","6","7","8","9","10","J","Q","K","A"],h;(function(r){r[r.Two=0]="Two",r[r.Three=1]="Three",r[r.Four=2]="Four",r[r.Five=3]="Five",r[r.Six=4]="Six",r[r.Seven=5]="Seven",r[r.Eight=6]="Eight",r[r.Nine=7]="Nine",r[r.Ten=8]="Ten",r[r.Jack=9]="Jack",r[r.Queen=10]="Queen",r[r.King=11]="King",r[r.Ace=12]="Ace"})(h||(h={}));var m=class{constructor(e,t){if(typeof e=="string"){let s=v.reduce((o,u)=>e.indexOf(u)>o?e.indexOf(u):o,-1);if(s<0||s>=v.length)throw new Error(`Carta ${e} \xE9 inv\xE1lida: n\xE3o h\xE1 naipe.`);let a=e.substring(0,s),i=e.substring(s);if(this._value=P.findIndex(o=>o===a),this._suit=v.findIndex(o=>o===i),this._value<0||this._value>=P.length)throw new Error(`Carta ${e} \xE9 inv\xE1lida: valor inexistente.`)}else{if(t===void 0)throw new Error("Carta sem naipe associado.");this._value=e,this._suit=t}}get value(){return this._value}get suit(){return this._suit}get str(){return P[this._value]+v[this._suit]}toString(){let e=n.black(P[this._value]),t=this._suit<2?n.red(v[this._suit]):n.black(v[this._suit]);return n.bgWhite(e)+n.bgWhite(t)}};function C(){let r=new p;for(let e=0;e<v.length;e++)for(let t=0;t<P.length;t++)r.push(new m(t,e));return r.shuffle(),r.shuffle(),r}var p=class{constructor(e=[]){this.cards=e}get length(){return this.cards.length}shuffle(){for(let e=this.cards.length-1;e>0;e--){let t=Math.floor(Math.random()*(e+1));[this.cards[e],this.cards[t]]=[this.cards[t],this.cards[e]]}}sort(){this.cards.sort((e,t)=>e.suit!=t.suit?e.suit-t.suit:e.value-t.value)}get str(){return`[ ${this.cards.map(e=>e.str).join(" ")} ]`}toString(){return`[ ${this.cards.join(" ")} ]`}get top(){return this.cards[this.cards.length-1]}pop(){return this.cards.pop()}push(e){e!==void 0&&this.cards.push(e)}pushCards(e){e.forEach(t=>this.cards.push(t))}indexOf(e){return this.cards.findIndex(t=>t.value===e.value&&t.suit===e.suit)}has(e){return this.indexOf(e)>=0}hasAll(e){return e.every(t=>this.has(t))}remove(e){let t=this.indexOf(e);return t<0?!1:(this.cards.splice(t,1),!0)}removeCards(e){e.forEach(t=>this.remove(t))}clear(){this.cards=[]}merge(e){for(;e.length>0;)this.push(e.pop());return this.shuffle(),this}isMeld(){if(this.cards.length<3||this.cards.length>14)return!1;let e=[],t=[],s=[];this.cards.forEach(i=>{i.value===12?e.push(i):i.value===0?s.push(i):t.push(i)});let a=t[0].suit;if(t.some(i=>i.suit!==a)||(t.sort((i,o)=>i.suit!=o.suit?i.suit-o.suit:i.value-o.value),s.length>2))return!1;if(s.length===2){if(s[0].suit!==a&&s[1].suit!==a)return!1;let i=s[0].suit===a?0:1;t.unshift(s.splice(i,1)[0])}if(e.length>2)return!1;e.length===2&&t.push(e.pop());for(let i=1;i<t.length;i++){let o=Math.abs(t[i].value-t[i-1].value);if(o===0||o>2)return!1;if(o===2){if(s.length===0)return!1;t.splice(i,0,s.pop()),i++}}if(e.length===1)if(t[0].value===0)t.unshift(e.pop());else if(t[t.length-1].value===11)t.push(e.pop());else if(s.length===1)if(t[0].value===1)t.unshift(s.pop()),t.unshift(e.pop());else if(t[t.length-1].value===10)t.push(s.pop()),t.push(e.pop());else return!1;else return!1;return s.length===1&&t.unshift(s.pop()),this.cards=t,!0}};var $=class{constructor(e=1){this.melds=[],this.playersHands=[new p],e==2&&this.playersHands.push(new p)}getHand(e=0){return this.playersHands[e]}};function I(r,e,t){let s=Math.floor((r-e.length)/2)-1,a=t.repeat(s),i=r-s-e.length-2,o=t.repeat(i),u=n.white(`${a} ${e} ${o}`);console.log(n.bgBlue(u))}function f(r=""){let e=80;console.log();let t=n.white("=".repeat(e)),s=n.bgBlue(t);Array.isArray(r)?(console.log(s),r.forEach(a=>I(e,a," ")),console.log(s)):r.length==0?console.log(s):I(e,r,"="),console.log()}var c;(function(r){r.SETUP="Configura\xE7\xE3o inv\xE1lida.",r.ACTION="A\xE7\xE3o inv\xE1lida.",r.FORMAT="Formato de mensagem inv\xE1lido.",r.CARD="Carta inv\xE1lida.",r.DECK="Sequ\xEAncia de cartas inv\xE1lida.",r.MELD="Jogo inv\xE1lido.",r.FILE="Arquivo inv\xE1lido."})(c||(c={}));var d=console.log,y=class{constructor(e){this.players=e;if(e.length!==2&&e.length!==4&&this.fail(c.SETUP,"O jogo deve ter dois ou quatro jogadores."),this.discardPile=new p,this.stock=C().merge(C()),this.playersPerTeam=e.length/2,this.team0=new $(this.playersPerTeam),this.team1=new $(this.playersPerTeam),y.initFile)this.initFromFile(y.initFile);else{for(let t=0;t<11;t++)for(let s=0;s<this.playersPerTeam;s++)this.team0.getHand(s).push(this.stock.pop()),this.team1.getHand(s).push(this.stock.pop());this.discardPile.push(this.stock.pop()),this.playerIndex=Math.floor(Math.random()*2*this.playersPerTeam)}}initFromFile(e){let t=(a,i)=>this.stock.remove(a)&&i.push(a),s=(a,i)=>{a.split(" ").slice(1,-1).map(o=>new m(o)).forEach(o=>t(o,i))};try{let i=O.readFileSync(e,"utf8").split(`
`).filter(o=>o.length>0);for(let o=0;o<this.playersPerTeam;o++)s(i[2*o+0],this.team0.getHand(o)),s(i[2*o+1],this.team1.getHand(o));t(new m(i[i.length-2]),this.discardPile),this.playerIndex=Number(i[i.length-1])}catch(a){console.error(a),this.closeGame()}}initialSetup(){d(`O jogo come\xE7a com o jogador ${this.currentPlayerName}.`),d(`A pilha de descarte come\xE7a inicialmente com a carta ${this.discardPile.top}.`);let e=this.players.reduce((t,s)=>t+s.id+" ","").trimEnd();this.players.forEach((t,s)=>{this.send(e,t),this.send(t.id,t),this.send(this.getHand(s).str,t),this.send(this.discardPile.top.str,t)})}closeGame(){this.players.forEach(e=>e.halt()),process.exit()}countPoints(e){let t=0;return e.cards.forEach(s=>{s.value>=h.Three&&s.value<=h.Seven?t+=5:s.value==h.Two||s.value>=h.Eight&&s.value<=h.King?t+=10:t+=15}),e.length>=7&&(t+=e.cards.some((a,i,o)=>{if(a.value!==h.Two)return!1;if(i<0){let u=o[i-1];if(u.value!==h.Ace||u.suit!==a.suit)return!0}if(i<o.length-1){let u=o[i+1];if(u.value!==h.Three||u.suit!==a.suit)return!0}return!1})?100:200),t}countTeamPoints(e){let t=e.melds.reduce((i,o)=>i+this.countPoints(o),0),s=this.countPoints(e.playersHands[0]);s===0&&(s=-100);let a=0;return this.playersPerTeam==2&&(a=this.countPoints(e.playersHands[1]),a===0&&(a=-100)),t-s-a}showPoints(e,t,s,a){e.forEach((i,o)=>d(`${i} tinha na m\xE3o as cartas ${t[o]}`)),s.length>0?(d("Os seguintes jogos foram baixados:"),s.forEach(i=>d(i.toString()))):d("Nenhum jogo foi baixado."),d(`Total de pontos: ${a} pontos`)}gameOver(e){f(e);let t=this.countTeamPoints(this.team0),s=this.countTeamPoints(this.team1),a=this.players[0].color(this.players[0].id),i=this.players[1].color(this.players[1].id);if(this.playersPerTeam===1)this.showPoints([a],[this.getHand(0)],this.team0.melds,t),f(),this.showPoints([i],[this.getHand(1)],this.team1.melds,s),f(),t===s&&d("Incr\xEDvel! Houve um empate!"),d(`${t>s?a:i} venceu.
`);else{let o=this.players[2].color(this.players[2].id),u=this.players[3].color(this.players[3].id);this.showPoints([a,o],[this.getHand(0),this.getHand(2)],this.team0.melds,t),f(),this.showPoints([i,u],[this.getHand(1),this.getHand(3)],this.team1.melds,s),f(),t===s&&d("Incr\xEDvel! Houve um empate!");let W=t>s?`${a} e ${o}`:`${i} e ${u}`;d(`${W} venceram.
`)}this.closeGame()}async run(){for(;;)this.broadcast(this.currentPlayer.id),await this.firstMove(),await this.secondMove(),this.playerIndex=(this.playerIndex+1)%this.players.length}async firstMove(){let{action:e,args:t}=await this.receiveAction();e==="GET_STOCK"?this.getStock():e==="GET_DISCARD"?(this.getDiscard(t),this.currentHand.cards.length===0&&this.gameOver(`Jogador ${this.currentPlayer.id} bateu.`)):this.fail(c.ACTION,`A primeira a\xE7\xE3o deve ser puxar uma carta do monte (GET_STOCK) ou do lixo (GET_DISCARD) e foi enviado ${n.yellow(e)}.`)}async secondMove(){let e;do{switch(e=await this.receiveAction(),e.action){case"MELD_NEW":this.createMeld(e.args);break;case"MELD_JOIN":this.joinMeld(e.args);break;case"DISCARD":this.discard(e.args);break;default:this.fail(c.ACTION,`Poss\xEDveis a\xE7\xF5es: MELD_NEW, MELD_JOIN ou DISCARD. A a\xE7\xE3o ${e.action} n\xE3o \xE9 poss\xEDvel.`);break}this.currentHand.cards.length===0&&this.gameOver(`Jogador ${this.currentPlayer.id} bateu.`)}while(e.action!=="DISCARD")}getStock(){let e=this.stock.pop();e?(this.currentHand.push(e),this.send(e.str),this.broadcastNonCurrent("GET_STOCK"),d(`${this.currentPlayerName} puxou uma carta do deque de compra.`)):this.gameOver("N\xE3o h\xE1 mais cartas para puxar. O jogo terminou.")}getDiscard(e){e.length<2&&this.fail(c.DECK,"\xC9 necess\xE1rio pelo menos duas cartas para se juntar com o topo do lixo.");let t;try{t=e.map(i=>new m(i))}catch(i){this.fail(c.CARD,i)}let s=this.discardPile.pop(),a=new p([s,...t]);this.currentHand.hasAll(t)===!1?this.fail(c.DECK,"Tentativa de forma jogo com cartas que n\xE3o est\xE3o na m\xE3o."):a.isMeld()?(this.currentTeam.melds.push(a),this.send(this.discardPile.str),this.broadcastNonCurrent(`GET_DISCARD [ ${e.join(" ")} ]`),this.currentHand.removeCards(t),this.currentHand.merge(this.discardPile),d(`${this.currentPlayerName} pegou o lixo e fez o jogo ${a}.`)):this.fail(c.MELD,`As cartas ${a} n\xE3o formam um jogo.`)}createMeld(e){let t;try{t=e.map(a=>new m(a))}catch(a){this.fail(c.CARD,a)}let s=new p(t);this.currentHand.hasAll(t)===!1?this.fail(c.DECK,"Tentativa de forma jogo com cartas que n\xE3o est\xE3o na m\xE3o."):s.isMeld()?(this.currentTeam.melds.push(s),this.currentHand.removeCards(t),this.broadcastNonCurrent(`MELD_NEW ${s.str}`),d(`${this.currentPlayerName} baixou o jogo ${s}.`)):this.fail(c.MELD,`As cartas ${s} n\xE3o formam um jogo.`)}joinMeld([e,...t]){let s=Number(e);(s<0||s>=this.currentTeam.melds.length)&&this.fail(c.FORMAT,`O identificador ${e} n\xE3o costa nos jogos da equipe.`),(t[0]!=="["||t[t.length-1]!=="]")&&this.fail(c.FORMAT,"As cartas a serem anexadas ao jogo devem estar entre [ ].");let a;try{a=t.slice(1,-1).map(o=>new m(o))}catch(o){this.fail(c.CARD,o)}let i=this.currentTeam.melds[s];if(i.pushCards(a),this.currentHand.hasAll(a)===!1)this.fail(c.DECK,"Tentativa de forma jogo com cartas que n\xE3o est\xE3o na m\xE3o.");else if(i.isMeld()){this.currentHand.removeCards(a);let o=new p(a);this.broadcastNonCurrent(`MELD_JOIN ${e} ${o.str}`),d(`${this.currentPlayerName} adicionou as cartas ${o.str} atualizando o jogo ${i}.`)}else this.fail(c.MELD,`As cartas ${i} n\xE3o formam um jogo.`)}discard(e){e.length===0&&this.fail(c.FORMAT,"\xC9 necess\xE1rio informar a carta a ser descartada na a\xE7\xE3o DISCARD"),e.length>1&&this.fail(c.FORMAT,"A\xE7\xE3o DISCARD requer um \xFAnico par\xE2metro, a carta a ser descartada");try{let t=new m(e[0]);this.currentHand.has(t)?(this.currentHand.remove(t),this.discardPile.push(t),this.broadcastNonCurrent(`DISCARD ${t.str}`),d(`${this.currentPlayerName} descartou a carta ${t}.`)):this.fail(c.CARD,`O jogador n\xE3o possui a carta ${t}.`)}catch(t){this.fail(c.CARD,t)}}async receive(){return await this.currentPlayer.read()}async receiveAction(){let e=await this.receive(),[t,...s]=e.split(" ").filter(a=>a.length>0);return s[0]==="["&&s[s.length-1]==="]"&&(s=s.slice(1,-1)),{action:t,args:s}}send(e,t=this.currentPlayer){return t.write(e)}broadcast(e,t=this.players){t.forEach(s=>this.send(e,s))}broadcastNonCurrent(e){this.broadcast(e,this.players.filter(t=>t!=this.currentPlayer))}fail(e,t){d(`${this.currentPlayerName}: ${n.red(e)} ${t}`),this.closeGame()}getTeam(e){return e%2==0?this.team0:this.team1}get currentTeam(){return this.getTeam(this.playerIndex)}get oponentTeam(){return this.getTeam(this.playerIndex)===this.team0?this.team1:this.team0}get currentPlayerName(){return this.currentPlayer.color(this.currentPlayer.id)}get currentPlayer(){return this.players[this.playerIndex]}get currentHand(){return this.getHand(this.playerIndex)}getHand(e){return this.getTeam(e).getHand(e<2?0:1)}};var L=g(require("path")),G=g(require("child_process"));var N=g(require("child_process")),S=g(require("stream")),R=g(require("readline"));function k(r){let e=R.createInterface({input:r}),t=async function*(){for await(let s of e)yield s}();return async()=>(await t.next()).value}function M(r){let e=new S.Readable({read:()=>{}}),t=N.fork(r);return t.on("message",s=>e.push(s)),{process:t,read:k(e),write:s=>t.send(`${s}
`)}}var D=console.log,Z=3e3,x=class{constructor(e,t){this.id=e;this.execName=t;this.proc=G.spawn(L.join(__dirname,t)),this.proc.on("error",s=>{D(n.red(`Erro na execu\xE7\xE3o do programa ${t}.`)),D(n.red(s)),this.halt()}),this.proc.stderr.on("data",s=>{let a=s.toString().replace(/\n/g,`
	`);D(n.red(`Bot ${e}:`)),D(n.red(`	${a}`))}),this._read=k(this.proc.stdout)}write(e){x.debug&&console.debug(`Enviando para ${this.id}: ${e}`),this.proc.stdin.write(`${e}
`)}async read(){let e,t=new Promise(i=>{e=setTimeout(()=>i("TIMEOUT"),3e3)}),s=this._read(),a=await Promise.race([t,s]);return a==="TIMEOUT"?(console.log(`Jogador ${this.id} n\xE3o enviou dados no tempo de ${Z}ms e foi eliminado.`),Promise.reject("Tempo esgotado.")):(clearTimeout(e),x.debug&&console.debug(`Recebido de ${this.id}: ${a}`),Promise.resolve(a))}halt(){this.proc.kill("SIGINT")}},w=x;w.debug=!1;var q=g(require("path"));var H=class{constructor(e){this.id="user";this.id=e,this.child=M(q.join(__dirname,e))}write(e){this.child.write(`${e}`)}async read(){return await this.child.read()}halt(){this.child.process.kill("SIGINT")}};var _=console.log,V=[n.cyan,n.yellow,n.magenta,n.cyan];function K(){let r=E.basename(process.argv[0]),e=E.basename(process.argv[1]);f(["Buraco"]),_(`
    Neste jogo, bots competem entre si numa partida de Buraco simplificada.
    Pode-se colocar de 1 at\xE9 4 bots para competir, especificando o caminho de
    seus execut\xE1veis na linha de comando.
    Caso haja um n\xFAmero \xEDmpar de bots, o usu\xE1rio ser\xE1 um dos jogadores
    completando as equipes.
    `),_(`Uso: ${r} ${e} [-h] [-d] [-i <arquivo>] bot1 [bot2 [bot3 [bot4]]]`),_(`
    -h: (help) Explica os par\xE2metros de linha de comando (esta ajuda).
    -d: (debug) Imprime as trocas de mensagens entre o jogo e os bots.
    -i: Inicia a partida com as cartas descritas no arquivo especificado (para testar estrat\xE9gias).
    bot1, bot2...: caminho para os execut\xE1veis dos bots.
    `)}async function ee(){let r=process.argv.slice(2).filter(s=>!s.startsWith("-")),e=[],t=r.length;if(t<1||t>4)K();else{t%2&&e.push(new H("user"));for(let s=0;s<t;s++){let a=r[s],i=`p${s+1}.${E.basename(a)}`;e.push(new w(i,a))}}return e.forEach((s,a)=>s.color=V[a]),e}async function te(){let r=await ee();f(["BURACO",`Jogadores : ${r.map(t=>t.id).join(", ")}`]);let e=new y(r);try{e.initialSetup(),await e.run()}catch(t){console.error(t),r.forEach(s=>s.halt())}}var b=process.argv.indexOf("-d");b>1&&(w.debug=!0,process.argv.splice(b,1));b=process.argv.indexOf("-i");b>1&&b<process.argv.length-1&&(y.initFile=process.argv[b+1],process.argv.splice(b,2));process.argv.includes("-h")||process.argv.length<3?K():te();
