var J=Object.create,C=Object.defineProperty,F=Object.getPrototypeOf,Q=Object.prototype.hasOwnProperty,z=Object.getOwnPropertyNames,Y=Object.getOwnPropertyDescriptor;var X=s=>C(s,"__esModule",{value:!0});var Z=(s,e,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of z(e))!Q.call(s,r)&&r!=="default"&&C(s,r,{get:()=>e[r],enumerable:!(t=Y(e,r))||t.enumerable});return s},g=s=>s&&s.__esModule?s:Z(X(C(s!=null?J(F(s)):{},"default",{value:s,enumerable:!0})),s);var A=g(require("path"));var q=g(require("fs"));var h=s=>`[${s}m`,$={bold:h("1"),black:h("30"),red:h("31"),green:h("32"),yellow:h("33"),blue:h("34"),magenta:h("35"),cyan:h("36"),white:h("37"),gray:h("90"),bgBlack:h("40"),bgRed:h("41"),bgGreen:h("42"),bgYellow:h("43"),bgBlue:h("44"),bgMagenta:h("45"),bgCyan:h("46"),bgWhite:h("47"),bgGray:h("100"),reset:h("0")};function V(s){return s.endsWith($.reset)?s:`${s}${$.reset}`}var n=Object.keys($).reduce((s,e)=>({...s,[e]:t=>V(`${$[e]}${t}`)}),{});var v="\u2665\u2666\u2663\u2660".split(""),I;(function(s){s[s.Heart=0]="Heart",s[s.Diamonds=1]="Diamonds",s[s.Clubs=2]="Clubs",s[s.Spades=3]="Spades"})(I||(I={}));var w=["2","3","4","5","6","7","8","9","10","J","Q","K","A"],d;(function(s){s[s.Two=0]="Two",s[s.Three=1]="Three",s[s.Four=2]="Four",s[s.Five=3]="Five",s[s.Six=4]="Six",s[s.Seven=5]="Seven",s[s.Eight=6]="Eight",s[s.Nine=7]="Nine",s[s.Ten=8]="Ten",s[s.Jack=9]="Jack",s[s.Queen=10]="Queen",s[s.King=11]="King",s[s.Ace=12]="Ace"})(d||(d={}));var m=class{constructor(e,t){if(typeof e=="string"){let r=v.reduce((o,u)=>e.indexOf(u)>o?e.indexOf(u):o,-1);if(r<0||r>=v.length)throw new Error(`Carta ${e} \xE9 inv\xE1lida: n\xE3o h\xE1 naipe.`);let a=e.substring(0,r),i=e.substring(r);if(this._value=w.findIndex(o=>o===a),this._suit=v.findIndex(o=>o===i),this._value<0||this._value>=w.length)throw new Error(`Carta ${e} \xE9 inv\xE1lida: valor inexistente.`)}else{if(t===void 0)throw new Error("Carta sem naipe associado.");this._value=e,this._suit=t}}get value(){return this._value}get suit(){return this._suit}get str(){return w[this._value]+v[this._suit]}toString(){let e=n.black(w[this._value]),t=this._suit<2?n.red(v[this._suit]):n.black(v[this._suit]);return n.bgWhite(e)+n.bgWhite(t)}};function k(){let s=new p;for(let e=0;e<v.length;e++)for(let t=0;t<w.length;t++)s.push(new m(t,e));return s.shuffle(),s.shuffle(),s}var p=class{constructor(e=[]){this.cards=e}get length(){return this.cards.length}shuffle(){for(let e=this.cards.length-1;e>0;e--){let t=Math.floor(Math.random()*(e+1));[this.cards[e],this.cards[t]]=[this.cards[t],this.cards[e]]}}sort(){this.cards.sort((e,t)=>e.suit!=t.suit?e.suit-t.suit:e.value-t.value)}get str(){return`[ ${this.cards.map(e=>e.str).join(" ")} ]`}toString(){return`[ ${this.cards.join(" ")} ]`}get top(){return this.cards[this.cards.length-1]}pop(){return this.cards.pop()}push(e){e!==void 0&&this.cards.push(e)}pushCards(e){e.forEach(t=>this.cards.push(t))}indexOf(e){return this.cards.findIndex(t=>t.value===e.value&&t.suit===e.suit)}has(e){return this.indexOf(e)>=0}hasAll(e){return e.every(t=>this.has(t))}remove(e){let t=this.indexOf(e);return t<0?!1:(this.cards.splice(t,1),!0)}removeCards(e){e.forEach(t=>this.remove(t))}clear(){this.cards=[]}merge(e){for(;e.length>0;)this.push(e.pop());return this.shuffle(),this}isMeld(){if(this.cards.length<3||this.cards.length>14)return!1;let e=[],t=[],r=[];this.cards.forEach(i=>{i.value===12?e.push(i):i.value===0?r.push(i):t.push(i)});let a=t[0].suit;if(t.some(i=>i.suit!==a)||(t.sort((i,o)=>i.suit!=o.suit?i.suit-o.suit:i.value-o.value),r.length>2))return!1;if(r.length===2){if(r[0].suit!==a&&r[1].suit!==a)return!1;let i=r[0].suit===a?0:1;t.unshift(r.splice(i,1)[0])}if(e.length>2)return!1;e.length===2&&t.push(e.pop());for(let i=1;i<t.length;i++){let o=Math.abs(t[i].value-t[i-1].value);if(o===0||o>2)return!1;if(o===2){if(r.length===0)return!1;t.splice(i,0,r.pop()),i++}}if(e.length===1)if(t[0].value===0)t.unshift(e.pop());else if(t[t.length-1].value===11)t.push(e.pop());else if(r.length===1)if(t[0].value===1)t.unshift(r.pop()),t.unshift(e.pop());else if(t[t.length-1].value===10)t.push(r.pop()),t.push(e.pop());else return!1;else return!1;return r.length===1&&t.unshift(r.pop()),this.cards=t,!0}};var T=class{constructor(e=1){this.melds=[],this.playersHands=[new p],e==2&&this.playersHands.push(new p)}getHand(e=0){return this.playersHands[e]}};function O(s,e,t){let r=Math.floor((s-e.length)/2)-1,a=t.repeat(r),i=s-r-e.length-2,o=t.repeat(i),u=n.white(`${a} ${e} ${o}`);console.log(n.bgBlue(u))}function f(s=""){let e=80;console.log();let t=n.white("=".repeat(e)),r=n.bgBlue(t);Array.isArray(s)?(console.log(r),s.forEach(a=>O(e,a," ")),console.log(r)):s.length==0?console.log(r):O(e,s,"="),console.log()}var G=g(require("path")),B=g(require("child_process"));var S=g(require("child_process")),N=g(require("stream")),R=g(require("readline"));function _(s){let e=R.createInterface({input:s}),t=async function*(){for await(let r of e)yield r}();return async()=>(await t.next()).value}function M(s){let e=new N.Readable({read:()=>{}}),t=S.fork(s);return t.on("message",r=>e.push(r)),{process:t,read:_(e),write:r=>t.send(`${r}
`)}}var D=console.log,ee=3e3,L=n.bgGreen(n.black("DEBUG:")),E=class{constructor(e,t){this.id=e;this.execName=t;this.proc=B.spawn(G.join(__dirname,t)),this.proc.on("error",r=>{D(n.red(`Erro na execu\xE7\xE3o do programa ${t}.`)),D(n.red(r)),this.halt()}),this.proc.stderr.on("data",r=>{let a=r.toString().replace(/\n/g,`
	`);D(n.red(`Bot ${e}:`)),D(n.red(`	${a}`))}),this._read=_(this.proc.stdout)}write(e){E.debug&&console.debug(`${L} Enviando para ${this.id}: ${e}`),this.proc.stdin.write(`${e}
`)}async read(){let e,t=new Promise(i=>{e=setTimeout(()=>i("TIMEOUT"),3e3)}),r=this._read(),a=await Promise.race([t,r]);return a==="TIMEOUT"?(console.log(`Jogador ${this.id} n\xE3o enviou dados no tempo de ${ee}ms e foi eliminado.`),Promise.reject("Tempo esgotado.")):(clearTimeout(e),E.debug&&console.debug(`${L} Recebido de ${this.id}: ${a}`),Promise.resolve(a))}halt(){this.proc.kill("SIGINT")}},y=E;y.debug=!1;var c;(function(s){s.SETUP="Configura\xE7\xE3o inv\xE1lida.",s.ACTION="A\xE7\xE3o inv\xE1lida.",s.FORMAT="Formato de mensagem inv\xE1lido.",s.CARD="Carta inv\xE1lida.",s.DECK="Sequ\xEAncia de cartas inv\xE1lida.",s.MELD="Jogo inv\xE1lido.",s.FILE="Arquivo inv\xE1lido."})(c||(c={}));var l=console.log,x=n.bgGreen(n.black("DEBUG:")),b=class{constructor(e){this.players=e;if(e.length!==2&&e.length!==4&&this.fail(c.SETUP,"O jogo deve ter dois ou quatro jogadores."),this.discardPile=new p,this.stock=k().merge(k()),this.playersPerTeam=e.length/2,this.team0=new T(this.playersPerTeam),this.team1=new T(this.playersPerTeam),b.initFile)this.initFromFile(b.initFile);else{for(let t=0;t<11;t++)for(let r=0;r<this.playersPerTeam;r++)this.team0.getHand(r).push(this.stock.pop()),this.team1.getHand(r).push(this.stock.pop());this.discardPile.push(this.stock.pop()),this.playerIndex=Math.floor(Math.random()*2*this.playersPerTeam)}}initFromFile(e){let t=(a,i)=>this.stock.remove(a)&&i.push(a),r=(a,i)=>{a.split(" ").slice(1,-1).map(o=>new m(o)).forEach(o=>t(o,i))};try{let i=q.readFileSync(e,"utf8").split(`
`).filter(o=>o.length>0);for(let o=0;o<this.playersPerTeam;o++)r(i[2*o+0],this.team0.getHand(o)),r(i[2*o+1],this.team1.getHand(o));t(new m(i[i.length-2]),this.discardPile),this.playerIndex=Number(i[i.length-1])}catch(a){console.error(a),this.closeGame()}}initialSetup(){l(`O jogo come\xE7a com o jogador ${this.currentPlayerName}.`),l(`A pilha de descarte come\xE7a inicialmente com a carta ${this.discardPile.top}.`);let e=this.players.reduce((t,r)=>t+r.id+" ","").trimEnd();this.players.forEach((t,r)=>{this.send(e,t),this.send(t.id,t),this.send(this.getHand(r).str,t),this.send(this.discardPile.top.str,t)})}closeGame(){this.players.forEach(e=>e.halt()),process.exit()}countPoints(e){let t=0;return e.cards.forEach(r=>{r.value>=d.Three&&r.value<=d.Seven?t+=5:r.value==d.Two||r.value>=d.Eight&&r.value<=d.King?t+=10:t+=15}),e.length>=7&&(t+=e.cards.some((a,i,o)=>{if(a.value!==d.Two)return!1;if(i<0){let u=o[i-1];if(u.value!==d.Ace||u.suit!==a.suit)return!0}if(i<o.length-1){let u=o[i+1];if(u.value!==d.Three||u.suit!==a.suit)return!0}return!1})?100:200),t}countTeamPoints(e){let t=e.melds.reduce((i,o)=>i+this.countPoints(o),0),r=this.countPoints(e.playersHands[0]);r===0&&(r=-100);let a=0;return this.playersPerTeam==2&&(a=this.countPoints(e.playersHands[1]),a===0&&(a=-100)),t-r-a}showPoints(e,t,r,a){e.forEach((i,o)=>l(`${i} tinha na m\xE3o as cartas ${t[o]}`)),r.length>0?(l("Os seguintes jogos foram baixados:"),r.forEach(i=>l(i.toString()))):l("Nenhum jogo foi baixado."),l(`Total de pontos: ${a} pontos`)}gameOver(e){f(e);let t=this.countTeamPoints(this.team0),r=this.countTeamPoints(this.team1),a=this.players[0].color(this.players[0].id),i=this.players[1].color(this.players[1].id);if(this.playersPerTeam===1)this.showPoints([a],[this.getHand(0)],this.team0.melds,t),f(),this.showPoints([i],[this.getHand(1)],this.team1.melds,r),f(),t===r&&l("Incr\xEDvel! Houve um empate!"),l(`${t>r?a:i} venceu.
`);else{let o=this.players[2].color(this.players[2].id),u=this.players[3].color(this.players[3].id);this.showPoints([a,o],[this.getHand(0),this.getHand(2)],this.team0.melds,t),f(),this.showPoints([i,u],[this.getHand(1),this.getHand(3)],this.team1.melds,r),f(),t===r&&l("Incr\xEDvel! Houve um empate!");let W=t>r?`${a} e ${o}`:`${i} e ${u}`;l(`${W} venceram.
`)}this.closeGame()}async run(){for(;;)this.broadcast(this.currentPlayer.id),await this.firstMove(),await this.secondMove(),this.playerIndex=(this.playerIndex+1)%this.players.length}async firstMove(){let{action:e,args:t}=await this.receiveAction();e==="GET_STOCK"?this.getStock():e==="GET_DISCARD"?(this.getDiscard(t),this.currentHand.cards.length===0&&this.gameOver(`Jogador ${this.currentPlayer.id} bateu.`)):this.fail(c.ACTION,`A primeira a\xE7\xE3o deve ser puxar uma carta do monte (GET_STOCK) ou do lixo (GET_DISCARD) e foi enviado ${n.yellow(e)}.`),this.showPlayerState()}async secondMove(){let e;do{switch(e=await this.receiveAction(),e.action){case"MELD_NEW":this.createMeld(e.args);break;case"MELD_JOIN":this.joinMeld(e.args);break;case"DISCARD":this.discard(e.args);break;default:this.fail(c.ACTION,`Poss\xEDveis a\xE7\xF5es: MELD_NEW, MELD_JOIN ou DISCARD. A a\xE7\xE3o ${e.action} n\xE3o \xE9 poss\xEDvel.`);break}this.currentHand.cards.length===0&&this.gameOver(`Jogador ${this.currentPlayer.id} bateu.`),this.showPlayerState()}while(e.action!=="DISCARD")}showPlayerState(){y.debug&&(l(`${x} M\xE3o do jogador ${this.currentPlayerName}`),l(`${x} ${this.currentHand}`),l(`${x} Jogos do jogador ${this.currentPlayerName}`),this.currentTeam.melds.forEach(e=>l(`${x} ${e}`)))}getStock(){let e=this.stock.pop();e?(this.currentHand.push(e),this.send(e.str),this.broadcastNonCurrent("GET_STOCK"),l(`${this.currentPlayerName} puxou uma carta do deque de compra.`)):this.gameOver("N\xE3o h\xE1 mais cartas para puxar. O jogo terminou.")}getDiscard(e){e.length<2&&this.fail(c.DECK,"\xC9 necess\xE1rio pelo menos duas cartas para se juntar com o topo do lixo.");let t;try{t=e.map(i=>new m(i))}catch(i){this.fail(c.CARD,i)}let r=this.discardPile.pop(),a=new p([r,...t]);this.currentHand.hasAll(t)===!1?this.fail(c.DECK,"Tentativa de forma jogo com cartas que n\xE3o est\xE3o na m\xE3o."):a.isMeld()?(this.currentTeam.melds.push(a),this.send(this.discardPile.str),this.broadcastNonCurrent(`GET_DISCARD [ ${e.join(" ")} ]`),this.currentHand.removeCards(t),this.currentHand.merge(this.discardPile),l(`${this.currentPlayerName} pegou o lixo e fez o jogo ${a}.`)):this.fail(c.MELD,`As cartas ${a} n\xE3o formam um jogo.`)}createMeld(e){let t;try{t=e.map(a=>new m(a))}catch(a){this.fail(c.CARD,a)}let r=new p(t);this.currentHand.hasAll(t)===!1?this.fail(c.DECK,"Tentativa de forma jogo com cartas que n\xE3o est\xE3o na m\xE3o."):r.isMeld()?(this.currentTeam.melds.push(r),this.currentHand.removeCards(t),this.broadcastNonCurrent(`MELD_NEW ${r.str}`),l(`${this.currentPlayerName} baixou o jogo ${r}.`)):this.fail(c.MELD,`As cartas ${r} n\xE3o formam um jogo.`)}joinMeld([e,...t]){let r=Number(e);(r<0||r>=this.currentTeam.melds.length)&&this.fail(c.FORMAT,`O identificador ${e} n\xE3o costa nos jogos da equipe.`),(t[0]!=="["||t[t.length-1]!=="]")&&this.fail(c.FORMAT,"As cartas a serem anexadas ao jogo devem estar entre [ ].");let a;try{a=t.slice(1,-1).map(o=>new m(o))}catch(o){this.fail(c.CARD,o)}let i=this.currentTeam.melds[r];if(i.pushCards(a),this.currentHand.hasAll(a)===!1)this.fail(c.DECK,"Tentativa de forma jogo com cartas que n\xE3o est\xE3o na m\xE3o.");else if(i.isMeld()){this.currentHand.removeCards(a);let o=new p(a);this.broadcastNonCurrent(`MELD_JOIN ${e} ${o.str}`),l(`${this.currentPlayerName} adicionou as cartas ${o.str} atualizando o jogo ${i}.`)}else this.fail(c.MELD,`As cartas ${i} n\xE3o formam um jogo.`)}discard(e){e.length===0&&this.fail(c.FORMAT,"\xC9 necess\xE1rio informar a carta a ser descartada na a\xE7\xE3o DISCARD"),e.length>1&&this.fail(c.FORMAT,"A\xE7\xE3o DISCARD requer um \xFAnico par\xE2metro, a carta a ser descartada");try{let t=new m(e[0]);this.currentHand.has(t)?(this.currentHand.remove(t),this.discardPile.push(t),this.broadcastNonCurrent(`DISCARD ${t.str}`),l(`${this.currentPlayerName} descartou a carta ${t}.`)):this.fail(c.CARD,`O jogador n\xE3o possui a carta ${t}.`)}catch(t){this.fail(c.CARD,t)}}async receive(){return await this.currentPlayer.read()}async receiveAction(){let e=await this.receive(),[t,...r]=e.split(" ").filter(a=>a.length>0);return r[0]==="["&&r[r.length-1]==="]"&&(r=r.slice(1,-1)),{action:t,args:r}}send(e,t=this.currentPlayer){return t.write(e)}broadcast(e,t=this.players){t.forEach(r=>this.send(e,r))}broadcastNonCurrent(e){this.broadcast(e,this.players.filter(t=>t!=this.currentPlayer))}fail(e,t){l(`${this.currentPlayerName}: ${n.red(e)} ${t}`),this.closeGame()}getTeam(e){return e%2==0?this.team0:this.team1}get currentTeam(){return this.getTeam(this.playerIndex)}get oponentTeam(){return this.getTeam(this.playerIndex)===this.team0?this.team1:this.team0}get currentPlayerName(){return this.currentPlayer.color(this.currentPlayer.id)}get currentPlayer(){return this.players[this.playerIndex]}get currentHand(){return this.getHand(this.playerIndex)}getHand(e){return this.getTeam(e).getHand(e<2?0:1)}};var K=g(require("path"));var H=class{constructor(e){this.id="user";this.id=e,this.child=M(K.join(__dirname,e))}write(e){this.child.write(`${e}`)}async read(){return await this.child.read()}halt(){this.child.process.kill("SIGINT")}};var j=console.log,te=[n.cyan,n.yellow,n.magenta,n.cyan];function U(){let s=A.basename(process.argv[0]),e=A.basename(process.argv[1]);f(["Buraco"]),j(`
    Neste jogo, bots competem entre si numa partida de Buraco simplificada.
    Pode-se colocar de 1 at\xE9 4 bots para competir, especificando o caminho de
    seus execut\xE1veis na linha de comando.
    Caso haja um n\xFAmero \xEDmpar de bots, o usu\xE1rio ser\xE1 um dos jogadores
    completando as equipes.
    `),j(`Uso: ${s} ${e} [-h] [-d] [-i <arquivo>] bot1 [bot2 [bot3 [bot4]]]`),j(`
    -h: (help) Explica os par\xE2metros de linha de comando (esta ajuda).
    -d: (debug) Imprime as trocas de mensagens entre o jogo e os bots.
    -i: Inicia a partida com as cartas descritas no arquivo especificado (para testar estrat\xE9gias).
    bot1, bot2...: caminho para os execut\xE1veis dos bots.
    `)}async function re(){let s=process.argv.slice(2).filter(r=>!r.startsWith("-")),e=[],t=s.length;if(t<1||t>4)U();else{t%2&&e.push(new H("user"));for(let r=0;r<t;r++){let a=s[r],i=`p${r+1}.${A.basename(a)}`;e.push(new y(i,a))}}return e.forEach((r,a)=>r.color=te[a]),e}async function se(){let s=await re();f(["BURACO",`Jogadores : ${s.map(t=>t.id).join(", ")}`]);let e=new b(s);try{e.initialSetup(),await e.run()}catch(t){console.error(t),s.forEach(r=>r.halt())}}var P=process.argv.indexOf("-d");P>1&&(y.debug=!0,process.argv.splice(P,1));P=process.argv.indexOf("-i");P>1&&P<process.argv.length-1&&(b.initFile=process.argv[P+1],process.argv.splice(P,2));process.argv.includes("-h")||process.argv.length<3?U():se();
